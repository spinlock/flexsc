Origin: http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=84a4211850e3d23a9d3a4f3b294752a3b30bc0ff
From 84a4211850e3d23a9d3a4f3b294752a3b30bc0ff Mon Sep 17 00:00:00 2001
From: Petr Baudis <pasky@suse.cz>
Date: Sun, 20 Feb 2011 07:59:49 -0500
Subject: [PATCH] Fix allocation when handling positional parameters in printf.

2011-01-27  Petr Baudis  <pasky@suse.cz>
	    Ulrich Drepper  <drepper@gmail.com>

	* stdio-common/vfprintf.c (vfprintf): Pass correct newlen
	to extend_alloca().
	* stdio-common/bug23.c: New file.
	* stdio-common/Makefile (tests): Add bug23.

CVE-2012-3404

---
 stdio-common/Makefile   |    3 ++-
 stdio-common/bug23.c    |   21 +++++++++++++++++++++
 stdio-common/vfprintf.c |    5 +++--
 3 files changed, 26 insertions(+), 3 deletions(-)
 create mode 100644 stdio-common/bug23.c

Index: b/stdio-common/Makefile
===================================================================
--- a/stdio-common/Makefile
+++ b/stdio-common/Makefile
@@ -67,7 +67,8 @@ tests := tstscanf test_rdwr test-popen t
 	 tst-sprintf tst-rndseek tst-fdopen tst-fphex \
 	 tst-popen tst-unlockedio tst-fmemopen2 tst-put-error tst-fgets \
 	 tst-fwrite bug16 bug17 tst-sprintf2 bug18 \
-	 bug19 tst-popen2 scanf14 scanf15 bug21 bug22 scanf16 scanf17 \
+	 bug19 tst-popen2 scanf14 scanf15 bug21 bug22 bug23 \
+	 scanf16 scanf17 \
 	 tst-setvbuf1 bug-vfprintf-nargs
 tests-$(OPTION_EGLIBC_LOCALE_CODE) \
       += tst-sscanf tst-swprintf bug15 test-vfprintf bug14 scanf13
Index: b/stdio-common/bug23.c
===================================================================
--- /dev/null
+++ b/stdio-common/bug23.c
@@ -0,0 +1,21 @@
+#include <stdio.h>
+#include <string.h>
+
+static char buf[32768];
+static const char expected[] = "\
+\n\
+a\n\
+abbcd55%%%%%%%%%%%%%%%%%%%%%%%%%%\n";
+
+static int
+do_test (void)
+{
+  snprintf (buf, sizeof (buf),
+	    "\n%1$s\n" "%1$s" "%2$s" "%2$s" "%3$s" "%4$s" "%5$d" "%5$d"
+	    "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n",
+	    "a", "b", "c", "d", 5);
+  return strcmp (buf, expected) != 0;
+}
+
+#define TEST_FUNCTION do_test ()
+#include "../test-skeleton.c"
Index: b/stdio-common/vfprintf.c
===================================================================
--- a/stdio-common/vfprintf.c
+++ b/stdio-common/vfprintf.c
@@ -1,4 +1,4 @@
-/* Copyright (C) 1991-2008, 2009   Free Software Foundation, Inc.
+/* Copyright (C) 1991-2008, 2009, 2010, 2011   Free Software Foundation, Inc.
    This file is part of the GNU C Library.
 
    The GNU C Library is free software; you can redistribute it and/or
@@ -1703,7 +1703,8 @@ do_positional:
 	  {
 	    /* Extend the array of format specifiers.  */
 	    struct printf_spec *old = specs;
-	    specs = extend_alloca (specs, nspecs_max, 2 * nspecs_max);
+	    specs = extend_alloca (specs, nspecs_max,
+				   2 * nspecs_max * sizeof (*specs));
 
 	    /* Copy the old array's elements to the new space.  */
 	    memmove (specs, old, nspecs * sizeof (struct printf_spec));
